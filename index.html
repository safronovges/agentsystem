<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Industrial Opportunity Agent — Africa Feed</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f5f7;--sidebar:#0f1923;--sidebar-text:#94a3b8;--sidebar-active:#3b82f6;
  --card:#ffffff;--border:#e2e8f0;--text:#0f172a;--text-2:#64748b;--text-3:#94a3b8;
  --blue:#3b82f6;--blue-dark:#2563eb;--green:#10b981;--red:#ef4444;--amber:#f59e0b;
  --purple:#8b5cf6;--teal:#14b8a6;
  --shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);
  --shadow-md:0 4px 12px rgba(0,0,0,.08),0 2px 4px rgba(0,0,0,.04);
  --radius:8px;--radius-lg:12px;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5;overflow:hidden;height:100vh}
#root{display:flex;height:100vh;overflow:hidden}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}

/* Sidebar */
.sidebar{width:220px;min-width:220px;background:var(--sidebar);display:flex;flex-direction:column;height:100vh;overflow-y:auto;z-index:50;transition:width .2s}
.sidebar-logo{padding:20px 16px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
.sidebar-logo-title{font-size:12px;font-weight:700;color:#fff;letter-spacing:.08em;text-transform:uppercase}
.sidebar-logo-sub{font-size:11px;color:#475569;margin-top:2px}
.sidebar-nav{flex:1;padding:12px 8px}
.nav-section{margin-bottom:16px}
.nav-section-label{font-size:10px;font-weight:600;color:#334155;letter-spacing:.1em;text-transform:uppercase;padding:0 8px;margin-bottom:4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;cursor:pointer;color:var(--sidebar-text);font-size:13px;font-weight:500;transition:all .15s;text-decoration:none;white-space:nowrap;overflow:hidden}
.nav-item:hover{background:rgba(255,255,255,.06);color:#e2e8f0}
.nav-item.active{background:rgba(59,130,246,.15);color:#60a5fa}
.nav-item .icon{width:16px;height:16px;flex-shrink:0;opacity:.7}
.nav-item.active .icon{opacity:1}
.sidebar-footer{padding:12px 8px;border-top:1px solid rgba(255,255,255,.06)}

/* Header */
.header{display:flex;align-items:center;gap:12px;padding:0 24px;height:56px;background:var(--card);border-bottom:1px solid var(--border);flex-shrink:0;z-index:40}
.header-title{flex:1}
.header-title h1{font-size:15px;font-weight:700;color:var(--text)}
.header-title p{font-size:12px;color:var(--text-2)}
.region-scope{display:flex;gap:2px;background:#f1f5f9;border-radius:6px;padding:3px}
.scope-btn{padding:4px 10px;border-radius:4px;border:none;background:transparent;font-size:12px;font-weight:500;cursor:pointer;color:var(--text-2);transition:all .15s;font-family:inherit}
.scope-btn.active{background:#fff;color:var(--blue);box-shadow:var(--shadow);font-weight:600}
.search-box{display:flex;align-items:center;gap:8px;background:#f8fafc;border:1px solid var(--border);border-radius:6px;padding:6px 10px;width:200px}
.search-box input{border:none;background:transparent;font-size:13px;outline:none;width:100%;color:var(--text);font-family:inherit}
.icon-btn{width:32px;height:32px;border-radius:6px;border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-2);transition:background .15s}
.icon-btn:hover{background:#f1f5f9}
.avatar{width:32px;height:32px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}

/* Main layout */
.main-wrapper{flex:1;display:flex;flex-direction:column;overflow:hidden}
.content-area{flex:1;overflow-y:auto;padding:20px 24px}
.content-with-drawer{display:flex;gap:0;height:100%;overflow:hidden}
.content-main{flex:1;overflow-y:auto;padding:20px 24px}

/* Footer */
.footer-bar{height:28px;background:#0f1923;display:flex;align-items:center;padding:0 20px;gap:20px;flex-shrink:0}
.footer-item{display:flex;align-items:center;gap:6px;font-size:11px;color:#475569;font-family:'DM Mono',monospace}
.footer-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.footer-sep{width:1px;height:12px;background:#1e293b}

/* KPI Cards */
.kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px}
.kpi-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow)}
.kpi-label{font-size:11px;font-weight:600;color:var(--text-2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
.kpi-value{font-size:24px;font-weight:700;color:var(--text);line-height:1}
.kpi-change{font-size:11px;margin-top:6px;color:var(--green);font-weight:500}
.kpi-change.neg{color:var(--red)}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow)}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-size:14px;font-weight:600;color:var(--text)}

/* Badges */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:100px;font-size:11px;font-weight:600;letter-spacing:.02em}
.badge-blue{background:#dbeafe;color:#1d4ed8}
.badge-green{background:#d1fae5;color:#065f46}
.badge-red{background:#fee2e2;color:#991b1b}
.badge-amber{background:#fef3c7;color:#92400e}
.badge-purple{background:#ede9fe;color:#5b21b6}
.badge-teal{background:#ccfbf1;color:#134e4a}
.badge-gray{background:#f1f5f9;color:#475569}
.badge-orange{background:#ffedd5;color:#9a3412}

/* Table */
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{padding:10px 12px;text-align:left;font-size:11px;font-weight:600;color:var(--text-2);background:#f8fafc;border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;letter-spacing:.03em;text-transform:uppercase;position:sticky;top:0;z-index:1}
thead th:hover{background:#f1f5f9}
tbody td{padding:10px 12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
tbody tr{transition:background .1s;cursor:pointer}
tbody tr:hover{background:#f8fafc}
tbody tr.selected{background:#eff6ff}

/* Filters row */
.filters-row{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.filter-select{border:1px solid var(--border);background:#fff;border-radius:6px;padding:6px 10px;font-size:12px;color:var(--text);cursor:pointer;outline:none;font-family:inherit}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:6px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit}
.btn-primary{background:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue-dark)}
.btn-secondary{background:#fff;color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:#f8fafc}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-ghost{background:transparent;color:var(--text-2);border:none;padding:4px 8px;font-size:12px;border-radius:4px}
.btn-ghost:hover{background:#f1f5f9;color:var(--text)}

/* Drawer */
.drawer{width:340px;min-width:340px;background:var(--card);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;height:100%}
.drawer-header{padding:16px 20px;border-bottom:1px solid var(--border)}
.drawer-body{padding:16px 20px;flex:1}
.drawer-section{margin-bottom:20px}
.drawer-section-title{font-size:11px;font-weight:700;color:var(--text-2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f8fafc}
.info-label{font-size:12px;color:var(--text-2)}
.info-value{font-size:12px;font-weight:600;color:var(--text)}
.bullet-list{list-style:none;padding:0}
.bullet-list li{padding:5px 0;font-size:13px;color:var(--text);display:flex;gap:8px;align-items:flex-start}
.bullet-list li::before{content:"›";color:var(--blue);font-size:15px;line-height:1;flex-shrink:0}
.evidence-card{background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:8px}
.drawer-actions{padding:16px 20px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px}

/* Toast */
.toast-container{position:fixed;bottom:48px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:9999}
.toast{background:#1e293b;color:#f1f5f9;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:500;box-shadow:var(--shadow-md);animation:slideIn .2s ease;display:flex;align-items:center;gap:8px;max-width:320px}
.toast.success{border-left:3px solid var(--green)}
.toast.error{border-left:3px solid var(--red)}
.toast.info{border-left:3px solid var(--blue)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Status indicator */
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0}
.status-healthy{background:var(--green)}
.status-degraded{background:var(--amber)}
.status-down{background:var(--red)}

/* Spreadsheet */
.sheet-grid{overflow:auto;max-height:calc(100vh - 240px)}
.sheet-grid table{font-size:12px}
.sheet-grid thead th{font-size:10px;padding:8px 10px}
.sheet-grid tbody td{padding:6px 10px}
.cell-input{border:none;background:transparent;width:100%;font-size:12px;font-family:inherit;color:var(--text);outline:none;padding:0}
.cell-input:focus{background:#eff6ff;border-radius:3px;padding:0 3px}
.checkbox{width:14px;height:14px;cursor:pointer;accent-color:var(--blue)}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;display:flex;align-items:center;justify-content:center}
.modal{background:#fff;border-radius:12px;padding:24px;width:480px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,.15)}
.modal-title{font-size:16px;font-weight:700;margin-bottom:16px}
.modal-close{float:right;cursor:pointer;color:var(--text-2);font-size:18px;line-height:1}

/* Timeline */
.timeline{list-style:none}
.timeline li{display:flex;gap:10px;padding:6px 0;font-size:12px}
.timeline-dot{width:8px;height:8px;border-radius:50%;margin-top:4px;flex-shrink:0}
.timeline-time{color:var(--text-2);min-width:80px}

/* Page sections */
.page-title{font-size:20px;font-weight:700;color:var(--text);margin-bottom:4px}
.page-subtitle{font-size:13px;color:var(--text-2);margin-bottom:20px}

/* Daily Digest */
.digest-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
.digest-rank{font-size:28px;font-weight:800;color:#e2e8f0;line-height:1}

/* Alert rules */
.rule-builder{background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:16px;font-family:'DM Mono',monospace;font-size:12px;line-height:2}
.rule-keyword{color:var(--blue);font-weight:600}
.rule-value{color:var(--purple)}
.rule-op{color:var(--green)}

/* Placeholder pages */
.placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;color:var(--text-2);gap:12px}
.placeholder svg{opacity:.3}

/* Mobile */
@media(max-width:768px){
  .sidebar{position:fixed;left:-220px;height:100vh;transition:left .3s;z-index:100}
  .sidebar.open{left:0}
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .content-with-drawer{flex-direction:column}
  .drawer{width:100%;min-width:0;height:auto}
  .header{padding:0 12px}
  .search-box{display:none}
}

.confidence-high::before{content:"↑";color:var(--green)}
.confidence-medium::before{content:"→";color:var(--amber)}
.confidence-low::before{content:"↓";color:var(--red)}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useCallback,useMemo,useRef} = React;

// ── MOCK DATA ────────────────────────────────────────────────────────────────

// Domain: Industrial processing equipment — grinding, compaction, classification, bulk handling
// for fertilizers, ores, lithium/battery materials, chemicals, salts, scrap recycling
const SECTORS = ["Fertilizer","Mining & Ore","Battery Materials","Bulk Chemicals","Recycling","Mineral Processing","Powder Coating","Cement & Lime","Salt & Potash","Solid Waste"];
const STAGES  = ["Tender","EOI","RFQ","Award","EIA","Financing"];
const REGIONS  = ["Africa","Europe","Asia"];
const COUNTRIES = {
  Africa: ["South Africa","Morocco","Nigeria","Zambia","Tanzania","Ghana","Ethiopia","Egypt","Mozambique","Namibia","Zimbabwe","Kenya","D.R. Congo","Côte d'Ivoire","Senegal"],
  Europe: ["Germany","Poland","Netherlands","France","Belgium","Spain","Finland","Norway","Sweden","Czechia","Romania","Hungary","Austria","Portugal","Italy"],
  Asia:   ["India","China","Indonesia","Vietnam","Philippines","Kazakhstan","Saudi Arabia","Malaysia","Thailand","Uzbekistan","Bangladesh","South Korea","Japan","Pakistan","Sri Lanka"]
};
const STATUSES = ["New","In Review","Contacted","Bid Prep","Submitted","Archived"];

// Realistic EPC contractors, engineering firms, and industrial buyers in this domain
const BUYERS = [
  "OCP Group","Mosaic Company","Yara International","ICL Group","EuroChem",
  "Nutrien Ltd","PhosAgro","Anglo American","Glencore","Sibanye-Stillwater",
  "CMOC Group","Lithium Americas","Ganfeng Lithium","CATL","Northvolt",
  "Albemarle Corporation","SQM","Evonik Industries","BASF SE","Solvay",
  "Umicore","Covestro","Omya AG","Imerys","Minerals Technologies"
];

function rand(arr){return arr[Math.floor(Math.random()*arr.length)]}
function randN(min,max){return Math.floor(Math.random()*(max-min+1))+min}
function randF(min,max){return parseFloat((Math.random()*(max-min)+min).toFixed(1))}
function fmtM(v){if(v>=1000)return `€${(v/1000).toFixed(0)}B`;return `€${v}M`}

const seed=(s)=>{let h=s;return()=>{h^=h<<13;h^=h>>17;h^=h<<5;return(h>>>0)/4294967295}};
const rng=seed(42);
function seededRand(arr){return arr[Math.floor(rng()*arr.length)]}
function seededN(min,max){return Math.floor(rng()*(max-min+1))+min}

// ── PROJECT NAMES: realistic industrial processing equipment project titles ──
const PROJECT_NAMES_AFRICA=[
  "Jorf Lasfar Phosphate HPGR Comminution Circuit Upgrade",
  "Kansanshi Copper Concentrator Roller Press Installation",
  "OCP Gantour Compaction-Granulation Fertilizer Line",
  "Thabazimbi Iron Ore Fine Screening & Classification System",
  "Takoradi Port Bulk Solid Handling & Conveying Revamp",
  "Rössing Uranium Mill HPGR Tertiary Crushing EPC",
  "Ahafo Gold Mine Secondary Crusher & Air Classifier Package",
  "Tronox Namakwa Mineral Sands Dry Separation Plant",
  "Dangote Apapa NPK Fertilizer Briquetting Press Line",
  "Lumwana Copper Mine Roller Screen & Discharge System",
  "Mopani Copper Smelter Slag Granulation & Cooling Unit",
  "Khoemacau Copper Primary Crusher Replacement Tender",
  "SAPREF Durban Solids Handling & Dosing System Upgrade",
  "Zimbabwe Lithium Project HPGR & Fine Grinding Circuit",
  "Nkana Copper Refinery Compaction & Briquetting Line",
  "Agadir Phosphate Beneficiation Roller Press System RFQ",
  "Sidi Chennane Mine Ultrafine Grinding Pilot Installation",
  "Kitwe Fertilizer Plant Twin-Screw Extrusion System EPC",
  "Moma Titanium Minerals Dry Screening & Air Classification",
  "Kabwe Zinc Mine Compaction Granulation Line Upgrade",
  "South African Potash Project Roller Press Compactor Package",
  "Mahad Rock Phosphate Bulk Material Handling System",
  "Nacala Fertilizer Terminal Conveying & Dosing Systems",
  "Bulyanhulu Gold Mine Fine Grinding Mill Replacement",
  "Feronia Palm Oil Waste Briquetting & Solidification Plant"
];
const PROJECT_NAMES_EUROPE=[
  "K+S Werra Potash Compaction-Granulation Line Modernisation",
  "BASF Ludwigshafen Powder Coating Extrusion System Upgrade",
  "Northvolt Ett Black Mass HPGR Comminution Circuit",
  "ICL Boulby Mine Roller Press & Fine Screening Revamp",
  "Evonik Marl Compaction Granulator for Specialty Chemicals",
  "EuroChem Lifosa NPK Fertilizer Briquetting Plant EPC",
  "Covestro Dormagen Cooling & Solidification System RFQ",
  "Solvay Rheinberg Ultrafine Grinding & Air Classification",
  "KGHM Lubin Copper Ore HPGR Circuit Capacity Expansion",
  "Umicore Olen Battery Recycling Black Mass Roller Press",
  "Heidelberg Materials Cement HPGR Replacement Programme",
  "Almatis Ludwigshafen Alumina Fine Grinding System Tender",
  "Yara Brunsbüttel Prilling & Briquetting Line Debottlenecking",
  "Omya Breitenbach Calcium Carbonate Ultrafine Grinding EPC",
  "Imerys Kaolin St-Austell Air Classifier Replacement Package",
  "AkzoNobel Powder Coatings Twin-Screw Extrusion Upgrade",
  "PhosAgro Cherepovets Compaction Granulation Greenfield Line",
  "Outotec Espoo HPGR Demo & Pilot Plant Installation",
  "Fertiberia Huelva Phosphoric Acid Solid Handling System",
  "PKN Orlen Polyolefin Pelletizing & Cooling System RFQ",
  "Boliden Harjavalta Copper Slag Granulation Plant Revamp",
  "INEOS Köln Polymer Compounding Twin-Screw System EOI",
  "Lanxess Leverkusen Specialty Salt Compaction Line Upgrade",
  "Recylex Villepinte Battery Scrap HPGR Processing Tender",
  "Nyrstar Port Pirie Zinc Smelter Discharge & Dosing Revamp"
];
const PROJECT_NAMES_ASIA=[
  "IFFCO Paradip NPK Fertilizer Compaction-Granulation EPC",
  "Ganfeng Lithium Xinyu HPGR Spodumene Comminution Circuit",
  "CATL Yibin Battery Materials Roller Press Electrode Line",
  "Tata Chemicals Mithapur Salt Compaction Granulation Upgrade",
  "Vale Moatize Coal Handling & Roller Screen System (Asia Ops)",
  "Coromandel International DAP Granulation & Cooling System",
  "POSCO Chemical Pohang Cathode Material Fine Grinding Plant",
  "Freeport Indonesia Copper HPGR Concentrator Expansion EPC",
  "Acwa Power Jubail Mineral Handling Conveying System RFQ",
  "India Potash Ltd Bulk Solid Handling & Discharge Systems",
  "Zijin Mining Tibet Copper Primary Crusher Replacement Tender",
  "Adaro Energy Kalimantan Coal Roller Screen & Classification",
  "Samsung SDI Ulsan Battery Scrap Twin-Screw Compounding Line",
  "Ma'aden Wa'ad Al Shamal DAP Briquetting & Compaction RFQ",
  "Hanwha Solutions Ulsan Polymer Powder Cooling System EPC",
  "Vedanta Lanjigarh Alumina Calciner Fine Screening Upgrade",
  "PT Bukit Asam Coal Fine Screening & Air Classification Revamp",
  "JSW Steel Vijayanagar Ore HPGR Circuit Debottlenecking",
  "Uzbek Potash Dehkanabad Compaction Granulation Greenfield",
  "LG Chem Ochang Cathode Powder Ultrafine Grinding System",
  "PhilPhos Leyte Phosphate Fertilizer Roller Press Installation",
  "Hindalco Renukoot Aluminium Dross Briquetting Plant Tender",
  "PTT GC Rayong Polymer Pelletizing & Discharge System RFQ",
  "Bin Qasim Fertilizers Karachi Granulation Line Capacity Upgrade",
  "Oyu Tolgoi Mongolia Copper HPGR & Roller Screen Package"
];

// Equipment types used as a supplementary field
const EQUIPMENT_TYPES = [
  "HPGR","Roller Press","Briquetting Press","Air Classifier","Primary Crusher","Secondary Crusher",
  "Roller Screen","Twin-Screw Extruder","Cooling System","Dosing System","Conveying System",
  "Fine Screening System","Compaction Granulator","Discharge System","Solidification System"
];
const PROCESS_TYPES = [
  "Ultrafine Grinding","Compaction Granulation","Briquetting","Fine Grinding","Classification",
  "Crushing","Screening","Powder Coating","Cooling","Solidification","Compaction","Granulation"
];
const MATERIAL_TYPES = [
  "Phosphate Ore","Potash","NPK Fertilizer","Copper Ore","Lithium Spodumene","Black Mass / Battery Scrap",
  "Iron Ore","Cement Clinker","Alumina","Calcium Carbonate","Polymer Powder","Specialty Salts",
  "Coal Fines","Zinc Concentrate","Titanium Minerals","Kaolin","Solid Chemical Compounds"
];


// ── MATCHING PARTNERS ─────────────────────────────────────────────────────────
const PARTNERS = [
  "SEP Salt & Evaporation Plants",
  "ALPA Powder Technology",
  "Sahut-Conreur",
  "Trennso-Technik",
  "NEUMAN & ESSER",
  "ATM Recycling Systems",
  "MIXACO Maschinenbau",
  "CPC Crushing Processing GmbH",
  "GKM Siebtechnik",
  "Xtrutech",
  "BBA Innova",
  "Geroldinger"
];

// Partner → best-fit equipment types (for realistic assignment)
const PARTNER_EQUIPMENT_FIT = {
  "SEP Salt & Evaporation Plants":   ["Cooling System","Solidification System","Dosing System","Discharge System"],
  "ALPA Powder Technology":          ["Air Classifier","Fine Screening System","Conveying System"],
  "Sahut-Conreur":                   ["Roller Press","Compaction Granulator","Briquetting Press"],
  "Trennso-Technik":                 ["Air Classifier","Fine Screening System","Roller Screen"],
  "NEUMAN & ESSER":                  ["Primary Crusher","Secondary Crusher","HPGR"],
  "ATM Recycling Systems":           ["Twin-Screw Extruder","Discharge System","Conveying System"],
  "MIXACO Maschinenbau":             ["Dosing System","Conveying System","Fine Screening System"],
  "CPC Crushing Processing GmbH":    ["Primary Crusher","Secondary Crusher","Roller Screen"],
  "GKM Siebtechnik":                 ["Roller Screen","Fine Screening System","Air Classifier"],
  "Xtrutech":                        ["Twin-Screw Extruder","Extrusion System"],
  "BBA Innova":                      ["Compaction Granulator","Briquetting Press","Roller Press"],
  "Geroldinger":                     ["Conveying System","Bulk Material Handling","Discharge System"]
};

function assignPartner(equipment){
  // Find partners whose fit list includes this equipment type
  const fits = PARTNERS.filter(p =>
    PARTNER_EQUIPMENT_FIT[p].some(e => equipment && equipment.toLowerCase().includes(e.split(" ")[0].toLowerCase()))
  );
  if(fits.length > 0) return fits[Math.floor(Math.random()*fits.length)];
  return PARTNERS[Math.floor(Math.random()*PARTNERS.length)];
}


// ── CONTACT DATA ──────────────────────────────────────────────────────────────
// Realistic procurement / project contact names per region
const CONTACT_NAMES_AFRICA = [
  ["Kwame Asante","k.asante@ocpgroup.ma","+212 537 66 12 34"],
  ["Fatima El Mansouri","f.elmansouri@ump.ac.ma","+212 661 23 45 67"],
  ["Chukwuemeka Obi","c.obi@dangote.com","+234 803 456 7890"],
  ["Amara Diallo","a.diallo@mincom.gov.gh","+233 302 665 421"],
  ["Sipho Dlamini","s.dlamini@angloamerican.com","+27 11 638 9111"],
  ["Nadia Soussi","n.soussi@oc.ma","+212 522 23 45 67"],
  ["Emmanuel Boateng","e.boateng@zppa.org.zm","+260 211 252 984"],
  ["Abebe Girma","a.girma@mowie.gov.et","+251 11 551 5666"],
  ["Zanele Mokoena","z.mokoena@sibanye.com","+27 83 444 5566"],
  ["Mohamed Salah","m.salah@gafi.gov.eg","+20 2 2407 2000"],
  ["Yaw Darko","y.darko@mincom.gov.gh","+233 244 123 456"],
  ["Priscilla Owusu","p.owusu@miningindaba.com","+233 302 780 234"],
];
const CONTACT_NAMES_EUROPE = [
  ["Dr. Markus Brandt","m.brandt@kpluss.com","+49 561 9301 0"],
  ["Sophie Leclerc","s.leclerc@totalenergies.com","+33 1 47 44 45 46"],
  ["Piotr Kowalski","p.kowalski@kghm.com","+48 76 747 8200"],
  ["Elena Voronova","e.voronova@eurochem.com","+41 22 715 33 00"],
  ["Jochen Müller","j.mueller@basf.com","+49 621 60 0"],
  ["Annika Lindqvist","a.lindqvist@boliden.com","+46 8 610 15 00"],
  ["Remy Fontaine","r.fontaine@icis.com","+33 1 44 69 40 00"],
  ["Ingrid Haugen","i.haugen@yara.com","+47 24 15 70 00"],
  ["Klaus Hofmann","k.hofmann@evonik.com","+49 201 177 01"],
  ["Maria Santos","m.santos@fertiberia.es","+34 91 745 75 00"],
  ["Bart van der Berg","b.vandenberg@icl-group.com","+31 20 406 8511"],
  ["Elżbieta Nowak","e.nowak@orlen.pl","+48 24 256 00 00"],
];
const CONTACT_NAMES_ASIA = [
  ["Rajesh Nair","r.nair@iffco.in","+91 11 2655 0100"],
  ["Li Wei","l.wei@ganfenglithium.com","+86 791 7037 580"],
  ["Priya Sharma","p.sharma@coromandel.com","+91 40 2784 2398"],
  ["Hironori Tanaka","h.tanaka@posco-chemical.com","+82 54 220 0114"],
  ["Siti Rahimah","s.rahimah@petronas.com.my","+60 3 2051 5044"],
  ["Nguyen Thi Lan","n.t.lan@mpi.gov.vn","+84 24 3734 6600"],
  ["Amit Verma","a.verma@jsw.in","+91 22 4286 1000"],
  ["Fatimah Al-Rashid","f.alrashid@maaden.com.sa","+966 11 874 8000"],
  ["Park Ji-ho","j.park@lgchem.com","+82 2 3773 1114"],
  ["Ravi Subramanian","r.subramanian@vedanta.co.in","+91 22 6646 1000"],
  ["Sunita Patel","s.patel@tatachem.com","+91 22 6665 8282"],
  ["Ahmad Bin Zayed","a.binzayed@acwapower.com","+966 11 874 9999"],
];

// ~25% of opportunities get "Not found" for contact details (varies per field)
// We use the seeded rng so it's deterministic
function pickContact(region){
  const pool = region==="Africa"?CONTACT_NAMES_AFRICA:region==="Europe"?CONTACT_NAMES_EUROPE:CONTACT_NAMES_ASIA;
  // ~25% chance email not found, ~30% chance phone not found (independently)
  const contact = seededRand(pool);
  const emailFound  = seededN(0,3) > 0; // 75% found
  const phoneFound  = seededN(0,2) > 0; // 67% found
  return {
    contactName:  contact[0],
    contactEmail: emailFound  ? contact[1] : "Not found",
    contactPhone: phoneFound  ? contact[2] : "Not found",
  };
}

let _id=1;
function makeOpp(region){
  const countries=COUNTRIES[region];
  const country=seededRand(countries);
  const sector=seededRand(SECTORS);
  const stage=seededRand(STAGES);
  const value=seededN(2,80); // Equipment projects: typically €2M–€80M
  const score=seededN(40,99);
  const conf=score>=75?"High":score>=55?"Medium":"Low";
  const names=region==="Africa"?PROJECT_NAMES_AFRICA:region==="Europe"?PROJECT_NAMES_EUROPE:PROJECT_NAMES_ASIA;
  const project=names[_id%names.length];
  const deadline=new Date(2025+seededN(0,2),seededN(0,11),seededN(1,28));
  const discovered=new Date(2026,1,seededN(1,26),seededN(6,22),seededN(0,59));
  const srcId=`src-${region.toLowerCase()}-${seededN(1,10)}`;
  const equipment=seededRand(EQUIPMENT_TYPES);
  const process=seededRand(PROCESS_TYPES);
  const material=seededRand(MATERIAL_TYPES);
  return {
    id:`opp-${_id++}`,region,country,sector,stage,value,
    project,deadline:deadline.toISOString().split("T")[0],
    discovered:discovered.toLocaleString(),
    buyer:seededRand(BUYERS),epc:"",
    equipment,process,material,
    confidence:conf,matchScore:score,
    status:seededRand(STATUSES),
    sourceId:srcId,sourceUrl:`https://procurement.${country.toLowerCase().replace(/[\s']/g,"-")}.industry/tender`,
    watchlistTags:score>=80?["Priority","Equipment Match"]:[],
    assignedTo:seededRand(["P. Hoffmann","S. Müller","A. Diallo","K. Patel","—"]),
    matchingPartner:assignPartner(equipment),
    ...pickContact(region),
    notes:"",isDuplicate:false
  };
}

const OPPORTUNITIES=[];
for(let i=0;i<40;i++){OPPORTUNITIES.push(makeOpp("Africa"))}
for(let i=0;i<35;i++){OPPORTUNITIES.push(makeOpp("Europe"))}
for(let i=0;i<35;i++){OPPORTUNITIES.push(makeOpp("Asia"))}

// ── SOURCE TYPES for industrial processing intelligence ──
const SOURCE_TYPES=["Tender Portal","Industry Newsroom","Trade Magazine","EPC Database"];
const SOURCE_NAMES_AFRICA=[
  ["African Mining Briefs","https://www.africanminingbriefs.com","Africa"],
  ["Mining Review Africa","https://www.miningreview.com","Africa"],
  ["Engineering News South Africa","https://www.engineeringnews.co.za","Africa"],
  ["Morocco OCP Procurement Portal","https://achats.ocpgroup.ma","Africa"],
  ["South Africa CIDB Tenders","https://www.cidb.org.za/tenders","Africa"],
  ["Mining Indaba Project Database","https://www.miningindaba.com/projects","Africa"],
  ["Zambia ZPPA Tender Portal","https://www.zppa.org.zm/tenders","Africa"],
  ["African Fertilizer Agribusiness","https://www.africafertilizer.org","Africa"],
  ["Ghana Minerals Commission","https://www.mincom.gov.gh/tenders","Africa"],
  ["Africa Chemical Industry News","https://www.chemafricaindustry.com","Africa"],
  ["Tanzania PPRA Tenders","https://www.ppra.go.tz","Africa"],
  ["Namibia Tender Bulletin","https://www.tender.org.na","Africa"],
  ["ICMM Africa Mining Projects","https://www.icmm.com/projects/africa","Africa"],
  ["DRC Mining Weekly","https://www.drcmining.cd/tenders","Africa"],
  ["African Development Bank — Agro-Industry","https://www.afdb.org/en/sectors/agriculture","Africa"],
];
const SOURCE_NAMES_EUROPE=[
  ["TED — EU Official Tenders","https://ted.europa.eu","Europe"],
  ["Bundesanzeiger Germany Procurement","https://www.bund.de/IMPORTE/Bekanntmachungen","Europe"],
  ["Fertilizer International Magazine","https://www.fertilizerinternational.com","Europe"],
  ["Industrial Minerals (IM)","https://www.indmin.com","Europe"],
  ["Mining Technology Europe","https://www.mining-technology.com","Europe"],
  ["ICIS Chemical Business","https://www.icis.com/chemicals","Europe"],
  ["K+S Group Investment Portal","https://www.kpluss.com/investors/projects","Europe"],
  ["KGHM Project Procurement","https://www.kghm.com/procurement","Europe"],
  ["Euractiv Industrial Policy","https://www.euractiv.com/sections/energy","Europe"],
  ["European Chemical News","https://www.chemweek.com/europe","Europe"],
];
const SOURCE_NAMES_ASIA=[
  ["India eProcurement Portal","https://eprocure.gov.in","Asia"],
  ["Asian Mining Congress Projects","https://www.asianminingcongress.com","Asia"],
  ["Ma'aden Saudi Arabia Procurement","https://procurement.maaden.com.sa","Asia"],
  ["ICIS Asia Chemical News","https://www.icis.com/asia","Asia"],
  ["Fertilizer Asia — IFA","https://www.fertilizer.org/projects-asia","Asia"],
  ["Indonesian Mining Journal","https://www.indonesianmining.com","Asia"],
  ["India Fertiliser Tenders (DAC)","https://www.dac.gov.in/tenders","Asia"],
  ["Vietnam Industrial Procurement","https://muasamcong.mpi.gov.vn","Asia"],
  ["POSCO Chemical Projects","https://www.posco-chemical.com/projects","Asia"],
  ["ADB Clean Industry Projects Asia","https://www.adb.org/sectors/industry","Asia"],
];
const ALL_SOURCE_NAMES=[...SOURCE_NAMES_AFRICA,...SOURCE_NAMES_EUROPE,...SOURCE_NAMES_ASIA];

const srng=seed(99);
function srN(min,max){return Math.floor(srng()*(max-min+1))+min}
function srnd(arr){return arr[Math.floor(srng()*arr.length)]}

const SOURCES=ALL_SOURCE_NAMES.map(([name,url,region],i)=>{
  const status=i<(region==="Africa"?11:region==="Europe"?7:7)?"Healthy":i%5===0?"Down":"Degraded";
  const latency=srN(180,1800);
  return {
    id:`src-${region.toLowerCase()}-${(i%10)+1}`,name,url,
    type:srnd(SOURCE_TYPES),region,
    sectors:[srnd(SECTORS),srnd(SECTORS)].filter((v,i,a)=>a.indexOf(v)===i),
    status,lastChecked:"09:38",lastSuccess:"09:35",
    errorRate:status==="Healthy"?srN(0,3):status==="Degraded"?srN(5,20):srN(30,80),
    latency,items7d:srN(12,340),
    notes:status==="Down"?"Requires auth update":status==="Degraded"?"Intermittent timeouts":"",
    robotsBlocked:srN(0,1)===1,requiresJs:srN(0,1)===1
  };
});

// ── TOAST SYSTEM ─────────────────────────────────────────────────────────────
const ToastCtx=React.createContext(null);
function ToastProvider({children}){
  const [toasts,setToasts]=useState([]);
  const add=useCallback((msg,type="info")=>{
    const id=Date.now();
    setToasts(t=>[...t,{id,msg,type}]);
    setTimeout(()=>setToasts(t=>t.filter(x=>x.id!==id)),3500);
  },[]);
  return(
    <ToastCtx.Provider value={add}>
      {children}
      <div className="toast-container">
        {toasts.map(t=>(
          <div key={t.id} className={`toast ${t.type}`}>
            {t.type==="success"?"✓":t.type==="error"?"✗":"ℹ"} {t.msg}
          </div>
        ))}
      </div>
    </ToastCtx.Provider>
  );
}
const useToast=()=>React.useContext(ToastCtx);

// ── ICONS ────────────────────────────────────────────────────────────────────
const Icon=({name,size=16,color="currentColor"})=>{
  const icons={
    dashboard:`<rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/>`,
    opportunities:`<path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="15" y2="16"/>`,
    sources:`<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>`,
    digest:`<path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"/><path d="M2 8h4"/><path d="M2 12h4"/><path d="M2 16h4"/>`,
    alerts:`<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>`,
    search:`<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>`,
    watchlist:`<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>`,
    exports:`<polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"/>`,
    settings:`<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>`,
    bell:`<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>`,
    sun:`<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>`,
    external:`<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>`,
    check:`<polyline points="20 6 9 17 4 12"/>`,
    x:`<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>`,
    chevron:`<polyline points="6 9 12 15 18 9"/>`,
    plus:`<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>`,
    download:`<polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"/>`,
    grid:`<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>`,
    list:`<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>`,
    info:`<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>`,
  };
  return(
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" dangerouslySetInnerHTML={{__html:icons[name]||""}} style={{flexShrink:0}}/>
  );
};

// ── HELPERS ──────────────────────────────────────────────────────────────────
const sectorColor=(s)=>({
  Energy:"badge-amber",Mining:"badge-gray",Water:"badge-teal",Transport:"badge-purple",
  Telecom:"badge-blue",Agriculture:"badge-green",Construction:"badge-orange",
  "Oil & Gas":"badge-red",Renewables:"badge-green",Waste:"badge-gray"
}[s]||"badge-blue");

const confIcon=(c)=>c==="High"?"↑ ":c==="Medium"?"→ ":"↓ ";
const confColor=(c)=>c==="High"?"#10b981":c==="Medium"?"#f59e0b":"#ef4444";

const StatusDot=({status})=>(
  <span className={`status-dot status-${status.toLowerCase()}`}/>
);

// ── SIDEBAR ──────────────────────────────────────────────────────────────────
const NAV=[
  {id:"dashboard",label:"Dashboard",icon:"dashboard"},
  {id:"opportunities",label:"Opportunities",icon:"opportunities"},
  {id:"sources",label:"Sources",icon:"sources"},
  {id:"digest",label:"Daily Digest",icon:"digest"},
  {id:"weekly-digest",label:"Weekly Digest",icon:"digest"},
  {id:"alerts",label:"Alerts",icon:"alerts"},
  {id:"search",label:"Search",icon:"search"},
  {id:"watchlists",label:"Watchlists",icon:"watchlist"},
  {id:"exports",label:"Exports",icon:"exports"},
  {id:"settings",label:"Settings",icon:"settings"},
];

function Sidebar({activePage,onNav}){
  return(
    <div className="sidebar">
      <div className="sidebar-logo">
        <div className="sidebar-logo-title">IOA Platform</div>
        <div className="sidebar-logo-sub">Equipment Discovery · Live</div>
      </div>
      <nav className="sidebar-nav">
        <div className="nav-section">
          <div className="nav-section-label">Main</div>
          {NAV.slice(0,3).map(n=>(
            <div key={n.id} className={`nav-item${activePage===n.id?" active":""}`} onClick={()=>onNav(n.id)}>
              <Icon name={n.icon} size={15}/>
              {n.label}
            </div>
          ))}
        </div>
        <div className="nav-section">
          <div className="nav-section-label">Tools</div>
          {NAV.slice(3,6).map(n=>(
            <div key={n.id} className={`nav-item${activePage===n.id?" active":""}`} onClick={()=>onNav(n.id)}>
              <Icon name={n.icon} size={15}/>
              {n.label}
            </div>
          ))}
        </div>
        <div className="nav-section">
          <div className="nav-section-label">Manage</div>
          {NAV.slice(6).map(n=>(
            <div key={n.id} className={`nav-item${activePage===n.id?" active":""}`} onClick={()=>onNav(n.id)}>
              <Icon name={n.icon} size={15}/>
              {n.label}
            </div>
          ))}
        </div>
      </nav>
      <div className="sidebar-footer">
        <div style={{fontSize:11,color:"#334155",display:"flex",alignItems:"center",gap:6}}>
          <span className="status-dot status-healthy"/>
          <span>All systems operational</span>
        </div>
      </div>
    </div>
  );
}

// ── HEADER ───────────────────────────────────────────────────────────────────
const SCOPE_OPTS=["Africa","Europe","Asia","All Regions"];
function Header({scope,onScope,search,onSearch,activePage}){
  const subtitle={Africa:"Africa Equipment Feed",Europe:"Europe Equipment Feed",Asia:"Asia Equipment Feed","All Regions":"Global Equipment Feed"}[scope];
  return(
    <div className="header">
      <div className="header-title">
        <h1>Industrial Equipment Agent</h1>
        <p>{subtitle} · {activePage.charAt(0).toUpperCase()+activePage.slice(1)}</p>
      </div>
      <div className="region-scope">
        {SCOPE_OPTS.map(s=>(
          <button key={s} className={`scope-btn${scope===s?" active":""}`} onClick={()=>onScope(s)}>{s}</button>
        ))}
      </div>
      <div className="search-box">
        <Icon name="search" size={13} color="#94a3b8"/>
        <input placeholder="Search..." value={search} onChange={e=>onSearch(e.target.value)}/>
      </div>
      <button className="icon-btn" title="Notifications"><Icon name="bell" size={16}/></button>
      <button className="icon-btn" title="Theme"><Icon name="sun" size={16}/></button>
      <div className="avatar">JO</div>
    </div>
  );
}

// ── FOOTER ───────────────────────────────────────────────────────────────────
function Footer(){
  const [time,setTime]=useState(new Date());
  useEffect(()=>{const t=setInterval(()=>setTime(new Date()),60000);return()=>clearInterval(t)},[]);
  const fmt=(d)=>d.toTimeString().slice(0,5);
  const next=new Date(time.getTime()+8*60000);
  return(
    <div className="footer-bar">
      <div className="footer-item"><span className="footer-dot"/><span>Crawlers: Active</span></div>
      <div className="footer-sep"/>
      <div className="footer-item">Dedupe: 98%</div>
      <div className="footer-sep"/>
      <div className="footer-item">Last Scan: {fmt(time)}</div>
      <div className="footer-sep"/>
      <div className="footer-item">Next Scan: {fmt(next)}</div>
      <div className="footer-sep"/>
      <div className="footer-item" style={{marginLeft:"auto"}}>IOA Platform · Industrial Equipment Discovery</div>
    </div>
  );
}

// ── KPI CARD ─────────────────────────────────────────────────────────────────
function KpiCard({label,value,change,changeType="pos"}){
  return(
    <div className="kpi-card">
      <div className="kpi-label">{label}</div>
      <div className="kpi-value">{value}</div>
      {change&&<div className={`kpi-change${changeType==="neg"?" neg":""}`}>{change}</div>}
    </div>
  );
}

// ── OPPORTUNITY DRAWER ────────────────────────────────────────────────────────
function OppDrawer({opp,onClose,onNavigateSource}){
  const toast=useToast();
  if(!opp)return(
    <div className="drawer" style={{alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:13,padding:20}}>
      <div style={{textAlign:"center"}}>
        <Icon name="info" size={32} color="var(--text-3)"/>
        <p style={{marginTop:12}}>Select a row to view details</p>
      </div>
    </div>
  );
  return(
    <div className="drawer">
      <div className="drawer-header">
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <div style={{flex:1,paddingRight:8}}>
            <div style={{fontSize:13,fontWeight:700,lineHeight:1.4}}>{opp.project}</div>
            <div style={{fontSize:11,color:"var(--text-2)",marginTop:4}}>{opp.country} · {opp.sector}</div>
          </div>
          {onClose&&<button className="icon-btn btn-sm" onClick={onClose}><Icon name="x" size={14}/></button>}
        </div>
        <div style={{display:"flex",gap:6,marginTop:10,flexWrap:"wrap"}}>
          <span className={`badge ${sectorColor(opp.sector)}`}>{opp.sector}</span>
          <span className="badge badge-gray">{opp.stage}</span>
          <span className="badge" style={{background:"#f0fdf4",color:confColor(opp.confidence)}}>{confIcon(opp.confidence)}{opp.confidence}</span>
        </div>
      </div>
      <div className="drawer-body">
        <div className="drawer-section">
          <div className="drawer-section-title">Agent Summary</div>
          <ul className="bullet-list">
            <li>{opp.stage} identified for <strong>{opp.equipment||"processing equipment"}</strong> supply in {opp.country} — keyword match on {opp.process||"comminution/compaction"}.</li>
            <li>Material: <strong>{opp.material||"bulk solids"}</strong> — aligns with target application portfolio for {opp.sector}.</li>
            <li>Buyer <strong>{opp.buyer}</strong> has active capex programme; award typically 60–90 days post EOI close.</li>
            <li>Score {opp.matchScore}/100 — equipment & process terms confirmed in source document. Act before {opp.deadline}.</li>
          </ul>
        </div>
        <div className="drawer-section">
          <div className="drawer-section-title">Extracted Info</div>
          <div className="info-row"><span className="info-label">Equipment Type</span><span className="info-value">{opp.equipment||"—"}</span></div>
          <div className="info-row"><span className="info-label">Process</span><span className="info-value">{opp.process||"—"}</span></div>
          <div className="info-row"><span className="info-label">Material</span><span className="info-value" style={{fontSize:11}}>{opp.material||"—"}</span></div>
          <div className="info-row"><span className="info-label">Buyer/Owner</span><span className="info-value">{opp.buyer}</span></div>
          <div className="info-row"><span className="info-label">Deadline</span><span className="info-value">{opp.deadline}</span></div>
          <div className="info-row"><span className="info-label">Est. Value</span><span className="info-value">{fmtM(opp.value)}</span></div>
          <div className="info-row"><span className="info-label">Match Score</span><span className="info-value" style={{color:confColor(opp.confidence)}}>{opp.matchScore}/100</span></div>
          <div className="info-row"><span className="info-label">Status</span><span className="info-value">{opp.status}</span></div>
          <div className="info-row"><span className="info-label">Assigned</span><span className="info-value">{opp.assignedTo}</span></div>
          <div className="info-row"><span className="info-label">Matching Partner</span><span className="info-value" style={{color:"var(--blue-dark)",fontWeight:700}}>{opp.matchingPartner||"—"}</span></div>
          <div className="info-row"><span className="info-label">Contact</span><span className="info-value">{opp.contactName||"—"}</span></div>
          <div className="info-row"><span className="info-label">Email</span><span className="info-value" style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:opp.contactEmail==="Not found"?"var(--text-3)":"var(--text)"}}>{opp.contactEmail||"—"}</span></div>
          <div className="info-row"><span className="info-label">Phone</span><span className="info-value" style={{fontFamily:"'DM Mono',monospace",fontSize:11,color:opp.contactPhone==="Not found"?"var(--text-3)":"var(--text)"}}>{opp.contactPhone||"—"}</span></div>
        </div>
        <div className="drawer-section">
          <div className="drawer-section-title">Evidence</div>
          <div className="evidence-card">
            <div style={{fontSize:12,fontWeight:600,marginBottom:6}}>Official Procurement Portal</div>
            <div style={{fontSize:11,color:"var(--text-2)",marginBottom:8}}>{opp.sourceUrl}</div>
            <div style={{display:"flex",justifyContent:"space-between",fontSize:11}}>
              <span style={{color:"var(--text-2)"}}>Found: {opp.discovered}</span>
              <span style={{color:confColor(opp.confidence),fontWeight:600}}>Score: {opp.matchScore}</span>
            </div>
            {onNavigateSource&&(
              <button className="btn btn-ghost btn-sm" style={{marginTop:8,width:"100%"}} onClick={()=>onNavigateSource(opp.sourceId)}>
                <Icon name="external" size={11}/>View Source
              </button>
            )}
          </div>
        </div>
      </div>
      <div className="drawer-actions">
        <button className="btn btn-primary" onClick={()=>toast("Generating brief… this may take a moment","info")}>Generate Brief</button>
        <button className="btn btn-secondary" onClick={()=>{
          if(opp.contactEmail&&opp.contactEmail!=="Not found"){
            toast(`Draft email to ${opp.contactEmail} created`,"success");
          } else {
            toast("No email address found for this contact","error");
          }
        }}>Draft Email {opp.contactEmail&&opp.contactEmail!=="Not found"?<span style={{fontSize:10,opacity:.7,marginLeft:4}}>↗</span>:<span style={{fontSize:10,color:"var(--red)",marginLeft:4}}>✗</span>}</button>
        <button className="btn btn-secondary" onClick={()=>toast("Added to CRM","success")}>Add to CRM</button>
      </div>
    </div>
  );
}

// ── SOURCE DRAWER ─────────────────────────────────────────────────────────────
function SourceDrawer({source,onClose}){
  const toast=useToast();
  const [testing,setTesting]=useState(false);
  const [localSrc,setLocalSrc]=useState(source);
  useEffect(()=>setLocalSrc(source),[source]);
  if(!localSrc)return(
    <div className="drawer" style={{display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:13}}>
      <div style={{textAlign:"center",padding:20}}><Icon name="sources" size={32} color="var(--text-3)"/><p style={{marginTop:12}}>Select a source to inspect</p></div>
    </div>
  );
  const runTest=()=>{
    setTesting(true);
    setTimeout(()=>{
      const ok=Math.random()>0.2;
      setLocalSrc(s=>({...s,status:ok?"Healthy":"Degraded",lastChecked:new Date().toTimeString().slice(0,5),latency:randN(200,900),errorRate:ok?randN(0,3):randN(5,20)}));
      toast(`Test crawl: ${ok?"Healthy ✓":"Degraded — check logs"}`,ok?"success":"error");
      setTesting(false);
    },1200);
  };
  const checks=[{t:"09:38",ok:true},{t:"09:30",ok:true},{t:"09:22",ok:localSrc.status!=="Healthy"},{t:"09:14",ok:true},{t:"09:06",ok:true},{t:"08:58",ok:localSrc.status!=="Down"},{t:"08:50",ok:true},{t:"08:42",ok:true},{t:"08:34",ok:localSrc.status==="Healthy"},{t:"08:26",ok:true}];
  return(
    <div className="drawer">
      <div className="drawer-header">
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
          <div style={{flex:1}}>
            <div style={{fontSize:13,fontWeight:700}}>{localSrc.name}</div>
            <div style={{fontSize:11,color:"var(--text-2)",marginTop:3,wordBreak:"break-all"}}>{localSrc.url}</div>
          </div>
          {onClose&&<button className="icon-btn btn-sm" onClick={onClose}><Icon name="x" size={14}/></button>}
        </div>
        <div style={{display:"flex",gap:6,marginTop:10,alignItems:"center"}}>
          <StatusDot status={localSrc.status}/>
          <span style={{fontSize:12,fontWeight:600}}>{localSrc.status}</span>
          <span className="badge badge-gray" style={{marginLeft:4}}>{localSrc.type}</span>
        </div>
      </div>
      <div className="drawer-body">
        <div className="drawer-section">
          <div className="drawer-section-title">Checks (last 10)</div>
          <ul className="timeline">
            {checks.map((c,i)=>(
              <li key={i}>
                <div className={`timeline-dot ${c.ok?"status-healthy":"status-down"}`}/>
                <span className="timeline-time">{c.t}</span>
                <span style={{fontSize:12,color:c.ok?"var(--green)":"var(--red)"}}>{c.ok?"OK":"Failed"}</span>
              </li>
            ))}
          </ul>
        </div>
        <div className="drawer-section">
          <div className="drawer-section-title">Flags</div>
          <div className="info-row"><span className="info-label">Robots Blocked</span><span className="info-value" style={{color:localSrc.robotsBlocked?"var(--red)":"var(--green)"}}>{localSrc.robotsBlocked?"Yes":"No"}</span></div>
          <div className="info-row"><span className="info-label">Requires JS</span><span className="info-value" style={{color:localSrc.requiresJs?"var(--amber)":"var(--green)"}}>{localSrc.requiresJs?"Yes":"No"}</span></div>
          <div className="info-row"><span className="info-label">Latency</span><span className="info-value">{localSrc.latency}ms</span></div>
          <div className="info-row"><span className="info-label">Error Rate (24h)</span><span className="info-value" style={{color:localSrc.errorRate>10?"var(--red)":"var(--text)"}}>{localSrc.errorRate}%</span></div>
          <div className="info-row"><span className="info-label">Items (7d)</span><span className="info-value">{localSrc.items7d}</span></div>
        </div>
        {localSrc.status!=="Healthy"&&(
          <div className="drawer-section">
            <div className="drawer-section-title">Last Error</div>
            <div style={{background:"#fef2f2",border:"1px solid #fecaca",borderRadius:6,padding:10,fontSize:12,color:"#991b1b",fontFamily:"'DM Mono',monospace"}}>
              {localSrc.status==="Down"?"403 Forbidden — credentials expired":"Timeout after 30s — HTML structure changed"}
            </div>
          </div>
        )}
        <div className="drawer-section">
          <div className="drawer-section-title">Sample Items</div>
          {[1,2,3].map(n=>(
            <div key={n} style={{padding:"8px 0",borderBottom:"1px solid #f1f5f9",fontSize:12}}>
              <div style={{fontWeight:600,marginBottom:2}}>Procurement Notice #{randN(10000,99999)}</div>
              <div style={{color:"var(--text-2)"}}>Found 2h ago · {localSrc.sectors[0]}</div>
            </div>
          ))}
        </div>
      </div>
      <div className="drawer-actions">
        <button className="btn btn-primary" onClick={runTest} disabled={testing}>
          {testing?"Crawling…":"Run Test Crawl"}
        </button>
        <button className="btn btn-secondary" onClick={()=>toast("Tag editor opened","info")}>Edit Tags</button>
        <button className="btn btn-secondary" style={{color:"var(--red)"}} onClick={()=>toast("Source disabled","error")}>Disable Source</button>
      </div>
    </div>
  );
}

// ── DASHBOARD ─────────────────────────────────────────────────────────────────
function Dashboard({scope,search,onNavigateSource,onNavigatePage}){
  const toast=useToast();
  const [selectedOpp,setSelectedOpp]=useState(null);
  const [sector,setSector]=useState("All");
  const [stage,setStage]=useState("All");

  const filtered=useMemo(()=>{
    let data=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    if(sector!=="All")data=data.filter(o=>o.sector===sector);
    if(stage!=="All")data=data.filter(o=>o.stage===stage);
    if(search)data=data.filter(o=>o.project.toLowerCase().includes(search.toLowerCase())||o.country.toLowerCase().includes(search.toLowerCase()));
    return data;
  },[scope,sector,stage,search]);

  const kpis=useMemo(()=>{
    const data=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    return{
      new24h:data.filter(o=>new Date(o.discovered)>new Date(Date.now()-86400000)).length||data.length,
      high:data.filter(o=>o.confidence==="High").length,
      countries:[...new Set(data.map(o=>o.country))].length,
      avgDetect:"4.2h",
      sources:SOURCES.filter(s=>scope==="All Regions"||s.region===scope).length
    };
  },[scope]);

  return(
    <div className="content-with-drawer" style={{height:"100%"}}>
      <div className="content-main">
        <div className="kpi-grid">
          <KpiCard label="New Equipment Leads (24h)" value={kpis.new24h} change={`+${Math.round(kpis.new24h*.12)} since yesterday`}/>
          <KpiCard label="High-Confidence Matches" value={kpis.high} change="HPGR / Roller Press / Classifier"/>
          <KpiCard label="Countries Covered" value={kpis.countries} change="Active market coverage"/>
          <KpiCard label="Avg. Time to Detect" value={kpis.avgDetect} change="↓ 1.3h vs last week"/>
          <KpiCard label="Industry Sources" value={kpis.sources} change={`${Math.round(kpis.sources*.9)} healthy`}/>
        </div>

        <div className="filters-row">
          <select className="filter-select" value={sector} onChange={e=>setSector(e.target.value)}>
            <option>All Sectors</option>{SECTORS.map(s=><option key={s}>{s}</option>)}
          </select>
          <select className="filter-select" value={stage} onChange={e=>setStage(e.target.value)}>
            <option>All Stages</option>{STAGES.map(s=><option key={s}>{s}</option>)}
          </select>
          <select className="filter-select"><option>≥ €2M</option><option>≥ €5M</option><option>≥ €20M</option></select>
          <select className="filter-select"><option>All Confidence</option><option>High</option><option>Medium</option></select>
          <div style={{marginLeft:"auto"}}/>
          <button className="btn btn-primary btn-sm" onClick={()=>toast("Export started — preparing CSV","info")}>
            <Icon name="download" size={13}/>Export
          </button>
        </div>

        <div className="card">
          <div className="table-wrap" style={{maxHeight:"calc(100vh - 340px)"}}>
            <table>
              <thead>
                <tr>
                  <th>Deadline</th><th>Country</th><th>Sector</th><th>Equipment</th><th>Project</th><th>Stage</th>
                  <th>Value</th><th>Buyer</th><th>Score</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filtered.slice(0,15).map(o=>(
                  <tr key={o.id} className={selectedOpp?.id===o.id?"selected":""} onClick={()=>setSelectedOpp(o)}>
                    <td style={{color:"var(--text-2)",fontSize:11,whiteSpace:"nowrap"}}>{o.deadline}</td>
                    <td style={{fontWeight:500,whiteSpace:"nowrap"}}>{o.country}</td>
                    <td><span className={`badge ${sectorColor(o.sector)}`}>{o.sector}</span></td>
                    <td style={{fontSize:12,fontWeight:600,whiteSpace:"nowrap",color:"var(--blue-dark)"}}>{o.equipment||"—"}</td>
                    <td style={{maxWidth:180,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontSize:12}} title={o.project}>{o.project}</td>
                    <td><span className="badge badge-gray">{o.stage}</span></td>
                    <td style={{fontWeight:600,whiteSpace:"nowrap"}}>{fmtM(o.value)}</td>
                    <td style={{fontSize:12,color:"var(--text-2)",maxWidth:120,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{o.buyer}</td>
                    <td style={{fontSize:12,fontWeight:700,color:confColor(o.confidence)}}>{o.matchScore}</td>
                    <td onClick={e=>e.stopPropagation()}>
                      <div style={{display:"flex",gap:4}}>
                        <button className="btn btn-ghost btn-sm" onClick={()=>setSelectedOpp(o)}>View</button>
                        <button className="btn btn-ghost btn-sm" onClick={()=>toast(`Brief for "${o.project.slice(0,30)}…" queued`,"info")}>Brief</button>
                        <button className="btn btn-ghost btn-sm" onClick={()=>toast("Alert set","success")}>Alert</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div style={{padding:"10px 16px",borderTop:"1px solid var(--border)",fontSize:12,color:"var(--text-2)"}}>
            Showing {Math.min(15,filtered.length)} of {filtered.length} opportunities
          </div>
        </div>
      </div>
      <OppDrawer opp={selectedOpp} onNavigateSource={(id)=>{onNavigatePage("sources");}} />
    </div>
  );
}

// ── SOURCES PAGE ──────────────────────────────────────────────────────────────
function Sources({scope,search,initialSourceId}){
  const toast=useToast();
  const [selectedSrc,setSelectedSrc]=useState(null);
  const [statusFilter,setStatusFilter]=useState("All");
  const [typeFilter,setTypeFilter]=useState("All");
  const [sortCol,setSortCol]=useState("name");
  const [sortDir,setSortDir]=useState(1);

  const filtered=useMemo(()=>{
    let data=scope==="All Regions"?SOURCES:SOURCES.filter(s=>s.region===scope);
    if(statusFilter!=="All")data=data.filter(s=>s.status===statusFilter);
    if(typeFilter!=="All")data=data.filter(s=>s.type===typeFilter);
    if(search)data=data.filter(s=>s.name.toLowerCase().includes(search.toLowerCase())||s.url.toLowerCase().includes(search.toLowerCase()));
    return [...data].sort((a,b)=>{
      const av=a[sortCol]??0,bv=b[sortCol]??0;
      return typeof av==="string"?av.localeCompare(bv)*sortDir:(av-bv)*sortDir;
    });
  },[scope,statusFilter,typeFilter,search,sortCol,sortDir]);

  useEffect(()=>{
    if(initialSourceId){const s=SOURCES.find(x=>x.id===initialSourceId);if(s)setSelectedSrc(s);}
  },[initialSourceId]);

  const kpis=useMemo(()=>{
    const data=scope==="All Regions"?SOURCES:SOURCES.filter(s=>s.region===scope);
    return{total:data.length,active:data.filter(s=>s.status==="Healthy").length,errors:data.filter(s=>s.status!=="Healthy").length,avgLatency:Math.round(data.reduce((a,s)=>a+s.latency,0)/data.length)||0};
  },[scope]);

  const sort=(col)=>{if(sortCol===col)setSortDir(d=>-d);else{setSortCol(col);setSortDir(1);}};

  return(
    <div className="content-with-drawer" style={{height:"100%"}}>
      <div className="content-main">
        <div className="page-title">Sources — Industry Intelligence Database</div>
        <div className="page-subtitle">Trade portals, tender feeds, and industry newsrooms monitored for equipment procurement signals</div>

        <div className="kpi-grid" style={{gridTemplateColumns:"repeat(4,1fr)"}}>
          <KpiCard label="Total Sources" value={kpis.total}/>
          <KpiCard label="Active / Healthy" value={kpis.active} change={`${Math.round(kpis.active/kpis.total*100)}% uptime`}/>
          <KpiCard label="Errors (24h)" value={kpis.errors} change={kpis.errors>3?"Action needed":"+0 new"} changeType={kpis.errors>3?"neg":"pos"}/>
          <KpiCard label="Avg Latency" value={`${kpis.avgLatency}ms`}/>
        </div>

        <div className="filters-row">
          <select className="filter-select" value={statusFilter} onChange={e=>setStatusFilter(e.target.value)}>
            <option>All</option><option>Healthy</option><option>Degraded</option><option>Down</option>
          </select>
          <select className="filter-select" value={typeFilter} onChange={e=>setTypeFilter(e.target.value)}>
            <option>All</option>{SOURCE_TYPES.map(t=><option key={t}>{t}</option>)}
          </select>
          <div style={{marginLeft:"auto"}}/>
          <button className="btn btn-primary btn-sm" onClick={()=>toast("Adding new source…","info")}>
            <Icon name="plus" size={13}/>Add Source
          </button>
        </div>

        <div className="card">
          <div className="table-wrap" style={{maxHeight:"calc(100vh - 340px)"}}>
            <table>
              <thead>
                <tr>
                  {["name","type","region","status","lastChecked","errorRate","latency","items7d"].map(col=>(
                    <th key={col} onClick={()=>sort(col)}>
                      {{name:"Name",type:"Type",region:"Region",status:"Status",lastChecked:"Last Check",errorRate:"Error%",latency:"Latency",items7d:"Items 7d"}[col]}
                      {sortCol===col&&(sortDir===1?" ↑":" ↓")}
                    </th>
                  ))}
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map(s=>(
                  <tr key={s.id} className={selectedSrc?.id===s.id?"selected":""} onClick={()=>setSelectedSrc(s)}>
                    <td style={{fontWeight:600,maxWidth:160,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}} title={s.name}>{s.name}</td>
                    <td><span className="badge badge-gray">{s.type}</span></td>
                    <td><span className="badge badge-blue">{s.region}</span></td>
                    <td><div style={{display:"flex",alignItems:"center",gap:6}}><StatusDot status={s.status}/><span style={{fontSize:12}}>{s.status}</span></div></td>
                    <td style={{fontSize:11,color:"var(--text-2)",fontFamily:"'DM Mono',monospace"}}>{s.lastChecked}</td>
                    <td style={{fontSize:12,color:s.errorRate>10?"var(--red)":"var(--text)"}}>{s.errorRate}%</td>
                    <td style={{fontSize:12,fontFamily:"'DM Mono',monospace"}}>{s.latency}ms</td>
                    <td style={{fontSize:12,fontWeight:600}}>{s.items7d}</td>
                    <td onClick={e=>e.stopPropagation()}>
                      <div style={{display:"flex",gap:4}}>
                        <button className="btn btn-ghost btn-sm" onClick={()=>window.open(s.url,"_blank")}>Open</button>
                        <button className="btn btn-ghost btn-sm" onClick={()=>{setSelectedSrc(s);}}>Inspect</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div style={{padding:"10px 16px",borderTop:"1px solid var(--border)",fontSize:12,color:"var(--text-2)"}}>
            {filtered.length} industry sources monitored · last full crawl 09:35
          </div>
        </div>
      </div>
      <SourceDrawer source={selectedSrc} onClose={()=>setSelectedSrc(null)}/>
    </div>
  );
}

// ── OPPORTUNITIES SPREADSHEET ─────────────────────────────────────────────────
function OpportunitiesSheet({scope,search}){
  const toast=useToast();
  const [data,setData]=useState(()=>OPPORTUNITIES.map(o=>({...o,notes:o.notes||""})));
  const [selectedOpp,setSelectedOpp]=useState(null);
  const [selected,setSelected]=useState(new Set());
  const [sortCol,setSortCol]=useState("discovered");
  const [sortDir,setSortDir]=useState(-1);
  const [view,setView]=useState("sheet");
  const [page,setPage]=useState(0);
  const [editCell,setEditCell]=useState(null);
  const PER_PAGE=20;

  const filtered=useMemo(()=>{
    let d=scope==="All Regions"?data:data.filter(o=>o.region===scope);
    if(search)d=d.filter(o=>o.project.toLowerCase().includes(search.toLowerCase())||o.country.toLowerCase().includes(search.toLowerCase()));
    return [...d].sort((a,b)=>{
      const av=a[sortCol]??0,bv=b[sortCol]??0;
      return typeof av==="string"?av.localeCompare(bv)*sortDir:(av-bv)*sortDir;
    });
  },[scope,search,data,sortCol,sortDir]);

  const paged=filtered.slice(page*PER_PAGE,(page+1)*PER_PAGE);
  const totalPages=Math.ceil(filtered.length/PER_PAGE);

  const sort=(col)=>{if(sortCol===col)setSortDir(d=>-d);else{setSortCol(col);setSortDir(1);}};
  const toggleSelect=(id)=>setSelected(s=>{const ns=new Set(s);ns.has(id)?ns.delete(id):ns.add(id);return ns;});

  const updateCell=(id,field,val)=>{
    setData(d=>d.map(o=>o.id===id?{...o,[field]:val}:o));
  };

  const COLS=[
    {k:"project",label:"Project",width:220,sticky:true},
    {k:"country",label:"Country",width:110},
    {k:"region",label:"Region",width:80},
    {k:"sector",label:"Sector",width:110},
    {k:"equipment",label:"Equipment Type",width:150},
    {k:"process",label:"Process",width:140},
    {k:"material",label:"Material",width:150},
    {k:"stage",label:"Stage",width:85},
    {k:"buyer",label:"Buyer/Owner",width:160},
    {k:"deadline",label:"Deadline",width:100},
    {k:"value",label:"Est. Value",width:90},
    {k:"confidence",label:"Confidence",width:95},
    {k:"matchScore",label:"Score",width:70},
    {k:"status",label:"Status",width:110},
    {k:"matchingPartner",label:"Partner Match",width:180},
    {k:"contactName",label:"Contact",width:130},
    {k:"contactEmail",label:"Email",width:170},
    {k:"contactPhone",label:"Phone",width:140},
    {k:"assignedTo",label:"Assigned",width:90},
    {k:"notes",label:"Notes",width:160},
  ];

  return(
    <div className="content-with-drawer" style={{height:"100%"}}>
      <div className="content-main" style={{overflow:"hidden",display:"flex",flexDirection:"column"}}>
        <div className="page-title">Opportunities — Database</div>
        <div className="page-subtitle">{filtered.length} equipment procurement leads · scope: {scope}</div>

        <div className="filters-row" style={{flexShrink:0}}>
          <div style={{display:"flex",gap:4,background:"#f1f5f9",borderRadius:6,padding:3}}>
            <button className={`scope-btn${view==="sheet"?" active":""}`} onClick={()=>setView("sheet")} style={{display:"flex",alignItems:"center",gap:4}}><Icon name="grid" size={12}/>Sheet</button>
            <button className={`scope-btn${view==="cards"?" active":""}`} onClick={()=>setView("cards")} style={{display:"flex",alignItems:"center",gap:4}}><Icon name="list" size={12}/>Cards</button>
          </div>
          <div style={{width:1,height:20,background:"var(--border)"}}/>
          <button className="btn btn-secondary btn-sm" onClick={()=>toast("Row added","success")}><Icon name="plus" size={12}/>Add Row</button>
          <button className="btn btn-secondary btn-sm" onClick={()=>toast("CSV import dialog opened","info")}>Import CSV</button>
          <button className="btn btn-primary btn-sm" onClick={()=>toast("Export started","info")}><Icon name="download" size={12}/>Export CSV</button>
          {selected.size>0&&<span style={{fontSize:12,color:"var(--blue)",fontWeight:600}}>{selected.size} selected</span>}
        </div>

        {view==="sheet"?(
          <div style={{flex:1,overflow:"auto",borderRadius:8,border:"1px solid var(--border)",background:"#fff"}}>
            <table style={{width:"max-content",minWidth:"100%",fontSize:12,borderCollapse:"collapse"}}>
              <thead style={{position:"sticky",top:0,zIndex:2,background:"#f8fafc"}}>
                <tr>
                  <th style={{width:36,padding:"8px 10px",borderBottom:"1px solid var(--border)",borderRight:"1px solid var(--border)"}}>
                    <input type="checkbox" className="checkbox" onChange={(e)=>{if(e.target.checked)setSelected(new Set(paged.map(o=>o.id)));else setSelected(new Set());}}/>
                  </th>
                  {COLS.map(c=>(
                    <th key={c.k} style={{width:c.width,padding:"8px 10px",textAlign:"left",fontSize:10,fontWeight:600,color:"var(--text-2)",textTransform:"uppercase",letterSpacing:".03em",cursor:"pointer",borderBottom:"1px solid var(--border)",userSelect:"none",whiteSpace:"nowrap",background:sortCol===c.k?"#eff6ff":"#f8fafc"}} onClick={()=>sort(c.k)}>
                      {c.label}{sortCol===c.k&&(sortDir===1?" ↑":" ↓")}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {paged.map((o,ri)=>(
                  <tr key={o.id} style={{background:selected.has(o.id)?"#eff6ff":ri%2===0?"#fff":"#fafafa",cursor:"pointer"}} onClick={()=>setSelectedOpp(o)}>
                    <td style={{padding:"6px 10px",borderBottom:"1px solid #f1f5f9",borderRight:"1px solid #f1f5f9"}} onClick={e=>e.stopPropagation()}>
                      <input type="checkbox" className="checkbox" checked={selected.has(o.id)} onChange={()=>toggleSelect(o.id)}/>
                    </td>
                    {COLS.map(c=>(
                      <td key={c.k} style={{padding:"6px 10px",borderBottom:"1px solid #f1f5f9",maxWidth:c.width,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}} onClick={e=>{e.stopPropagation();setSelectedOpp(o);}}>
                        {c.k==="sector"?<span className={`badge ${sectorColor(o.sector)}`}>{o.sector}</span>
                        :c.k==="confidence"?<span style={{fontSize:11,fontWeight:600,color:confColor(o.confidence)}}>{confIcon(o.confidence)}{o.confidence}</span>
                        :c.k==="stage"?<span className="badge badge-gray">{o.stage}</span>
                        :c.k==="status"?<span className="badge badge-blue">{o.status}</span>
                        :c.k==="value"?<span style={{fontWeight:600}}>{fmtM(o.value)}</span>
                        :c.k==="matchScore"?<span style={{fontWeight:600,color:confColor(o.confidence)}}>{o.matchScore}</span>
                        :c.k==="contactEmail"||c.k==="contactPhone"?<span style={{fontSize:11,fontFamily:"'DM Mono',monospace",color:o[c.k]==="Not found"?"var(--text-3)":"var(--text)",whiteSpace:"nowrap"}}>{o[c.k]||"—"}</span>
                        :c.k==="matchingPartner"?<span style={{fontSize:11,fontWeight:600,color:"var(--blue-dark)",whiteSpace:"nowrap"}}>{o.matchingPartner||"—"}</span>
                        :c.k==="notes"?<input className="cell-input" value={o.notes||""} placeholder="Add note…" onClick={e=>e.stopPropagation()} onChange={e=>updateCell(o.id,"notes",e.target.value)}/>
                        :<span>{o[c.k]}</span>}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ):(
          <div style={{flex:1,overflow:"auto"}}>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:12}}>
              {paged.map(o=>(
                <div key={o.id} className="card" style={{padding:16,cursor:"pointer"}} onClick={()=>setSelectedOpp(o)}>
                  <div style={{fontWeight:700,fontSize:13,marginBottom:8}}>{o.project}</div>
                  <div style={{display:"flex",gap:6,marginBottom:8,flexWrap:"wrap"}}>
                    <span className={`badge ${sectorColor(o.sector)}`}>{o.sector}</span>
                    <span className="badge badge-gray">{o.stage}</span>
                    <span style={{fontSize:11,color:confColor(o.confidence),fontWeight:600}}>{confIcon(o.confidence)}{o.confidence}</span>
                  </div>
                  <div style={{fontSize:12,color:"var(--text-2)"}}>{o.country} · {o.buyer}</div>
                  <div style={{fontSize:12,marginTop:6,display:"flex",justifyContent:"space-between"}}>
                    <span style={{fontWeight:600}}>{fmtM(o.value)}</span>
                    <span style={{color:"var(--text-2)"}}>Score: <strong style={{color:confColor(o.confidence)}}>{o.matchScore}</strong></span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        <div style={{display:"flex",alignItems:"center",gap:12,padding:"10px 0",flexShrink:0,borderTop:"1px solid var(--border)",marginTop:8}}>
          <span style={{fontSize:12,color:"var(--text-2)"}}>Page {page+1} of {totalPages}</span>
          <button className="btn btn-secondary btn-sm" disabled={page===0} onClick={()=>setPage(p=>p-1)}>← Prev</button>
          <button className="btn btn-secondary btn-sm" disabled={page>=totalPages-1} onClick={()=>setPage(p=>p+1)}>Next →</button>
          <span style={{marginLeft:"auto",fontSize:12,color:"var(--text-2)"}}>{filtered.length} total rows</span>
        </div>
      </div>
      <OppDrawer opp={selectedOpp}/>
    </div>
  );
}

// ── DAILY DIGEST ──────────────────────────────────────────────────────────────
function DailyDigest({scope}){
  const toast=useToast();
  const data=useMemo(()=>{
    const d=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    return d.sort((a,b)=>b.matchScore-a.matchScore).slice(0,5);
  },[scope]);
  const kpis=useMemo(()=>{
    const d=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    return{new:d.length,high:d.filter(o=>o.confidence==="High").length,value:d.reduce((a,o)=>a+o.value,0)};
  },[scope]);
  return(
    <div className="content-area">
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:20}}>
        <div>
          <div className="page-title">Daily Update — 27 Feb 2026</div>
          <div className="page-subtitle">{scope} scope · Automated equipment opportunity digest</div>
        </div>
        <button className="btn btn-primary" onClick={()=>toast("PDF generation started","info")}><Icon name="download" size={14}/>Download PDF</button>
      </div>
      <div className="kpi-grid" style={{gridTemplateColumns:"repeat(3,1fr)",marginBottom:24}}>
        <KpiCard label="Equipment Leads" value={kpis.new} change="Today's pipeline"/>
        <KpiCard label="High Priority" value={kpis.high} change="Requires action"/>
        <KpiCard label="Total Est. Value" value={`€${(kpis.value/1000).toFixed(0)}B`} change="Active pipeline"/>
      </div>
      <div style={{marginBottom:16,fontWeight:700,fontSize:15}}>Top Matches Today</div>
      {data.map((o,i)=>(
        <div key={o.id} className="digest-card">
          <div style={{display:"flex",gap:16,alignItems:"flex-start"}}>
            <div className="digest-rank">#{i+1}</div>
            <div style={{flex:1}}>
              <div style={{fontWeight:700,fontSize:14,marginBottom:4}}>{o.project}</div>
              <div style={{display:"flex",gap:6,marginBottom:8,flexWrap:"wrap"}}>
                <span className={`badge ${sectorColor(o.sector)}`}>{o.sector}</span>
                <span className="badge badge-gray">{o.stage}</span>
                <span className="badge badge-gray">{o.country}</span>
                <span style={{fontSize:11,color:confColor(o.confidence),fontWeight:600}}>{confIcon(o.confidence)}{o.confidence}</span>
              </div>
              <div style={{fontSize:13,marginBottom:8}}>
                <strong>Why it matches:</strong> {o.confidence}-confidence {o.stage} for <strong>{o.equipment||o.sector}</strong> ({o.process||"processing"}) in {o.country}. Material: {o.material||"bulk solids"}. Buyer: {o.buyer}. Score {o.matchScore}/100.
              </div>
              <div style={{fontSize:13,color:"var(--text-2)",marginBottom:6}}>
                <strong style={{color:"var(--text)"}}>Next step:</strong> Verify equipment spec in tender documents → assign to {o.assignedTo==="—"?"sales team":o.assignedTo} → submit capability statement / EOI before {o.deadline}.
              </div>
              <div style={{fontSize:12,background:"#eff6ff",borderRadius:6,padding:"5px 10px",display:"inline-flex",alignItems:"center",gap:6}}>
                <span style={{color:"var(--text-3)"}}>🤝 Partner match:</span>
                <strong style={{color:"var(--blue-dark)"}}>{o.matchingPartner||"—"}</strong>
              </div>
            </div>
            <div style={{textAlign:"right",flexShrink:0}}>
              <div style={{fontSize:24,fontWeight:800,color:confColor(o.confidence)}}>{o.matchScore}</div>
              <div style={{fontSize:10,color:"var(--text-2)"}}>Match Score</div>
              <div style={{fontWeight:700,marginTop:4}}>{fmtM(o.value)}</div>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}


// ── WEEKLY DIGEST ─────────────────────────────────────────────────────────────
function WeeklyDigest({scope}){
  const toast=useToast();
  const data=useMemo(()=>{
    const d=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    return d.sort((a,b)=>b.matchScore-a.matchScore).slice(0,10);
  },[scope]);
  const kpis=useMemo(()=>{
    const d=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    const byPartner={};
    d.forEach(o=>{if(o.matchingPartner){byPartner[o.matchingPartner]=(byPartner[o.matchingPartner]||0)+1;}});
    const topPartner=Object.entries(byPartner).sort((a,b)=>b[1]-a[1])[0];
    const byEquip={};
    d.forEach(o=>{if(o.equipment){byEquip[o.equipment]=(byEquip[o.equipment]||0)+1;}});
    const topEquip=Object.entries(byEquip).sort((a,b)=>b[1]-a[1])[0];
    return{
      total:d.length,
      high:d.filter(o=>o.confidence==="High").length,
      value:d.reduce((a,o)=>a+o.value,0),
      topPartner:topPartner?topPartner[0]:"—",
      topPartnerCount:topPartner?topPartner[1]:0,
      topEquip:topEquip?topEquip[0]:"—",
      topEquipCount:topEquip?topEquip[1]:0,
      newCountries:[...new Set(d.map(o=>o.country))].length
    };
  },[scope]);

  // Group top 10 by sector for the sector breakdown
  const bySector=useMemo(()=>{
    const d=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    const m={};
    d.forEach(o=>{m[o.sector]=(m[o.sector]||0)+1;});
    return Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,5);
  },[scope]);

  const partnerStats=useMemo(()=>{
    const d=scope==="All Regions"?OPPORTUNITIES:OPPORTUNITIES.filter(o=>o.region===scope);
    const m={};
    d.forEach(o=>{if(o.matchingPartner)m[o.matchingPartner]=(m[o.matchingPartner]||0)+1;});
    return Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,6);
  },[scope]);

  const weekRange="24 Feb – 2 Mar 2026";

  return(
    <div className="content-area">
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:20}}>
        <div>
          <div className="page-title">Weekly Digest — {weekRange}</div>
          <div className="page-subtitle">{scope} scope · 7-day equipment procurement intelligence summary</div>
        </div>
        <div style={{display:"flex",gap:8}}>
          <button className="btn btn-secondary" onClick={()=>toast("Email distribution started","info")}>✉ Email to Team</button>
          <button className="btn btn-primary" onClick={()=>toast("PDF generation started","info")}><Icon name="download" size={14}/>Download PDF</button>
        </div>
      </div>

      {/* KPI row */}
      <div className="kpi-grid" style={{gridTemplateColumns:"repeat(4,1fr)",marginBottom:24}}>
        <KpiCard label="Total Leads (7d)" value={kpis.total} change={`+${Math.round(kpis.total*.18)} vs prev week`}/>
        <KpiCard label="High Confidence" value={kpis.high} change={`${Math.round(kpis.high/kpis.total*100)}% of pipeline`}/>
        <KpiCard label="Est. Value Pipeline" value={`€${(kpis.value/1000).toFixed(1)}B`} change="Active opportunities"/>
        <KpiCard label="Countries Active" value={kpis.newCountries} change="Unique markets"/>
      </div>

      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:20,marginBottom:24}}>

        {/* Sector breakdown */}
        <div className="card">
          <div className="card-header"><div className="card-title">Leads by Sector (Top 5)</div></div>
          <div style={{padding:"12px 20px"}}>
            {bySector.map(([sector,count],i)=>{
              const pct=Math.round(count/kpis.total*100);
              return(
                <div key={sector} style={{marginBottom:12}}>
                  <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                    <span style={{fontSize:12,fontWeight:600}}>{sector}</span>
                    <span style={{fontSize:12,color:"var(--text-2)"}}>{count} leads · {pct}%</span>
                  </div>
                  <div style={{height:6,background:"#f1f5f9",borderRadius:10}}>
                    <div style={{height:6,width:`${pct}%`,background:i===0?"var(--blue)":i===1?"var(--teal)":i===2?"var(--purple)":i===3?"var(--amber)":"var(--green)",borderRadius:10,transition:"width .4s"}}/>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Partner activity */}
        <div className="card">
          <div className="card-header"><div className="card-title">Partner Match Distribution</div><span style={{fontSize:11,color:"var(--text-2)"}}>Auto-assigned this week</span></div>
          <div style={{padding:"12px 20px"}}>
            {partnerStats.map(([partner,count],i)=>{
              const pct=Math.round(count/kpis.total*100);
              return(
                <div key={partner} style={{display:"flex",alignItems:"center",gap:10,paddingBottom:8,borderBottom:"1px solid #f1f5f9",marginBottom:8}}>
                  <div style={{width:28,height:28,borderRadius:6,background:"#eff6ff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:800,color:"var(--blue)",flexShrink:0}}>{i+1}</div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:12,fontWeight:700,color:"var(--blue-dark)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{partner}</div>
                    <div style={{fontSize:11,color:"var(--text-2)"}}>{count} leads matched · {pct}%</div>
                  </div>
                  <span className="badge badge-blue">{count}</span>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Highlight stat bar */}
      <div style={{background:"#0f1923",borderRadius:12,padding:"16px 24px",marginBottom:24,display:"flex",gap:32,alignItems:"center"}}>
        <div>
          <div style={{fontSize:11,color:"#475569",fontWeight:600,textTransform:"uppercase",letterSpacing:".06em",marginBottom:4}}>Top Equipment Signal</div>
          <div style={{fontSize:18,fontWeight:800,color:"#60a5fa"}}>{kpis.topEquip}</div>
          <div style={{fontSize:11,color:"#334155"}}>{kpis.topEquipCount} occurrences this week</div>
        </div>
        <div style={{width:1,height:40,background:"#1e293b"}}/>
        <div>
          <div style={{fontSize:11,color:"#475569",fontWeight:600,textTransform:"uppercase",letterSpacing:".06em",marginBottom:4}}>Most Active Partner Match</div>
          <div style={{fontSize:18,fontWeight:800,color:"#34d399"}}>{kpis.topPartner}</div>
          <div style={{fontSize:11,color:"#334155"}}>{kpis.topPartnerCount} leads assigned this week</div>
        </div>
        <div style={{width:1,height:40,background:"#1e293b"}}/>
        <div>
          <div style={{fontSize:11,color:"#475569",fontWeight:600,textTransform:"uppercase",letterSpacing:".06em",marginBottom:4}}>Week-on-Week Change</div>
          <div style={{fontSize:18,fontWeight:800,color:"#f59e0b"}}>+{Math.round(kpis.total*.18)} leads</div>
          <div style={{fontSize:11,color:"#334155"}}>{Math.round(kpis.total*.18*kpis.value/kpis.total)}M additional est. value</div>
        </div>
        <div style={{marginLeft:"auto"}}>
          <button className="btn" style={{background:"#1e3a5f",color:"#60a5fa",border:"1px solid #2563eb"}} onClick={()=>toast("Full report exported","success")}><Icon name="download" size={13}/>Full Report</button>
        </div>
      </div>

      {/* Top 10 leads table */}
      <div className="card">
        <div className="card-header">
          <div className="card-title">Top 10 Equipment Leads This Week</div>
          <span style={{fontSize:11,color:"var(--text-2)"}}>Ranked by Match Score</span>
        </div>
        <div className="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Project</th><th>Country</th><th>Equipment</th><th>Stage</th><th>Value</th><th>Partner Match</th><th>Contact</th><th>Email</th><th>Score</th>
              </tr>
            </thead>
            <tbody>
              {data.map((o,i)=>(
                <tr key={o.id}>
                  <td style={{fontWeight:800,color:"#cbd5e1",fontSize:16,lineHeight:1}}>{i+1}</td>
                  <td style={{maxWidth:180,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:600,fontSize:12}} title={o.project}>{o.project}</td>
                  <td style={{fontWeight:500,fontSize:12}}>{o.country}</td>
                  <td><span className="badge badge-blue" style={{fontSize:10}}>{o.equipment||"—"}</span></td>
                  <td><span className="badge badge-gray">{o.stage}</span></td>
                  <td style={{fontWeight:700}}>{fmtM(o.value)}</td>
                  <td style={{fontSize:11,fontWeight:700,color:"var(--blue-dark)",maxWidth:130,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{o.matchingPartner||"—"}</td>
                  <td style={{fontSize:11,maxWidth:110,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{o.contactName||"—"}</td>
                  <td style={{fontSize:10,fontFamily:"'DM Mono',monospace",color:o.contactEmail==="Not found"?"var(--text-3)":"var(--text-2)",maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{o.contactEmail||"—"}</td>
                  <td><span style={{fontSize:13,fontWeight:800,color:confColor(o.confidence)}}>{o.matchScore}</span></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// ── ALERTS ────────────────────────────────────────────────────────────────────
function Alerts(){
  const toast=useToast();
  const rules=[
    {id:1,cond:"IF equipment == HPGR OR Roller Press AND stage == Tender AND confidence >= Medium",active:true,fired:3},
    {id:2,cond:"IF sector == Fertilizer AND region == Africa AND material CONTAINS Phosphate",active:true,fired:1},
    {id:3,cond:"IF matchScore >= 85 AND process == Compaction Granulation AND deadline < 45d",active:false,fired:0},
  ];
  const alerts=OPPORTUNITIES.filter(o=>o.matchScore>=75).slice(0,5);
  return(
    <div className="content-area">
      <div className="page-title">Alerts</div>
      <div className="page-subtitle">Rule-based alerts for HPGR, roller press, briquetting, and compaction-granulation procurement signals</div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:24}}>
        <div>
          <div style={{fontWeight:700,marginBottom:12}}>Active Rules</div>
          {rules.map(r=>(
            <div key={r.id} className="card" style={{padding:16,marginBottom:12}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                <span style={{fontSize:11,fontWeight:600,color:r.active?"var(--green)":"var(--text-3)"}}>{r.active?"● Active":"○ Paused"}</span>
                <span style={{fontSize:11,color:"var(--text-2)"}}>{r.fired} fired today</span>
              </div>
              <div className="rule-builder">
                {r.cond.split(/(IF|AND|==|>=|>)/).map((part,i)=>{
                  if(["IF","AND"].includes(part.trim()))return<span key={i} className="rule-keyword">{part}</span>;
                  if(["==",">=",">"].includes(part.trim()))return<span key={i} className="rule-op">{part}</span>;
                  return<span key={i}>{part}</span>;
                })}
              </div>
              <div style={{display:"flex",gap:8,marginTop:12}}>
                <button className="btn btn-secondary btn-sm" onClick={()=>toast("Rule edited","info")}>Edit</button>
                <button className="btn btn-secondary btn-sm" onClick={()=>toast(r.active?"Rule paused":"Rule activated",r.active?"error":"success")}>{r.active?"Pause":"Activate"}</button>
              </div>
            </div>
          ))}
          <button className="btn btn-primary btn-sm" onClick={()=>toast("Rule builder opened","info")}><Icon name="plus" size={12}/>New Rule</button>
        </div>
        <div>
          <div style={{fontWeight:700,marginBottom:12}}>Recent Alerts</div>
          {alerts.map(o=>(
            <div key={o.id} className="card" style={{padding:12,marginBottom:8}}>
              <div style={{fontWeight:600,fontSize:13,marginBottom:4}}>{o.project.slice(0,45)}{o.project.length>45?"…":""}</div>
              <div style={{display:"flex",gap:6,marginBottom:8}}>
                <span className={`badge ${sectorColor(o.sector)}`}>{o.sector}</span>
                <span className="badge badge-gray">{o.country}</span>
                <span style={{fontSize:11,color:confColor(o.confidence),fontWeight:600}}>{confIcon(o.confidence)}{o.confidence}</span>
              </div>
              <div style={{display:"flex",gap:6}}>
                <button className="btn btn-secondary btn-sm" onClick={()=>toast("Alert snoozed 24h","info")}>Snooze</button>
                <button className="btn btn-secondary btn-sm" onClick={()=>toast("Assigned to team","success")}>Assign</button>
                <button className="btn btn-primary btn-sm" onClick={()=>toast("Opening opportunity","info")}>Open</button>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ── PLACEHOLDER PAGES ─────────────────────────────────────────────────────────
function PlaceholderPage({title,icon}){
  return(
    <div className="content-area">
      <div className="page-title">{title}</div>
      <div className="placeholder">
        <Icon name={icon||"dashboard"} size={48} color="var(--text-3)"/>
        <div style={{fontSize:14,color:"var(--text-2)",textAlign:"center"}}>
          <strong>{title}</strong> is available in the full platform.<br/>
          <span style={{fontSize:12}}>This is a mockup — connect your data to activate.</span>
        </div>
      </div>
    </div>
  );
}

// ── APP ───────────────────────────────────────────────────────────────────────

// ── DISCLAIMER MODAL ──────────────────────────────────────────────────────────
function Disclaimer({onClose}){
  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.55)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",padding:20,backdropFilter:"blur(4px)"}}>
      <div style={{background:"#fff",borderRadius:16,padding:"36px 40px",maxWidth:560,width:"100%",boxShadow:"0 24px 80px rgba(0,0,0,.2)",position:"relative"}}>
        {/* Header strip */}
        <div style={{position:"absolute",top:0,left:0,right:0,height:4,background:"linear-gradient(90deg,#3b82f6,#6366f1)",borderRadius:"16px 16px 0 0"}}/>
        <div style={{display:"flex",alignItems:"flex-start",gap:16,marginBottom:20}}>
          <div style={{width:44,height:44,borderRadius:10,background:"#eff6ff",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          </div>
          <div>
            <div style={{fontSize:17,fontWeight:800,color:"#0f172a",marginBottom:3}}>Concept Mockup — Not a Live Product</div>
            <div style={{fontSize:12,color:"#64748b",fontWeight:500}}>Industrial Equipment Agent · Internal Preview</div>
          </div>
        </div>
        <p style={{fontSize:14,color:"#334155",lineHeight:1.7,marginBottom:14}}>
          This interface is a <strong>concept mockup</strong> built to illustrate a vision for an AI-powered industrial equipment procurement intelligence platform. All data shown — opportunities, sources, scores, partner matches, and KPIs — is <strong>entirely fictional and generated for demonstration purposes only</strong>.
        </p>
        <p style={{fontSize:14,color:"#334155",lineHeight:1.7,marginBottom:14}}>
          This mockup does not represent the final product. Features, workflows, data structures, and design may <strong>change significantly</strong> before any real product is built or released.
        </p>
        <div style={{background:"#f8fafc",border:"1px solid #e2e8f0",borderRadius:8,padding:"12px 14px",marginBottom:24,fontSize:13,color:"#475569",lineHeight:1.6}}>
          <strong style={{color:"#0f172a"}}>This is our current vision.</strong> We are using this prototype to explore the concept, gather feedback, and refine the product direction. The final product may differ substantially.
        </div>
        <div style={{display:"flex",justifyContent:"flex-end"}}>
          <button
            onClick={onClose}
            style={{background:"#3b82f6",color:"#fff",border:"none",borderRadius:8,padding:"10px 28px",fontSize:14,fontWeight:700,cursor:"pointer",fontFamily:"inherit",boxShadow:"0 2px 8px rgba(59,130,246,.35)",transition:"background .15s"}}
            onMouseEnter={e=>e.target.style.background="#2563eb"}
            onMouseLeave={e=>e.target.style.background="#3b82f6"}
          >
            I understand — Show me the concept
          </button>
        </div>
      </div>
    </div>
  );
}

function App(){
  const [page,setPage]=useState("dashboard");
  const [scope,setScope]=useState(()=>localStorage.getItem("ioa-scope")||"Africa");
  const [showDisclaimer,setShowDisclaimer]=useState(()=>!sessionStorage.getItem("ioa-disclaimer-seen"));
  const [search,setSearch]=useState("");
  const [jumpSourceId,setJumpSourceId]=useState(null);

  useEffect(()=>{localStorage.setItem("ioa-scope",scope);},[scope]);

  const handleScope=(s)=>{setScope(s);setSearch("");};
  const handleNav=(p)=>{setPage(p);setSearch("");if(p!=="sources")setJumpSourceId(null);};
  const handleNavigateSource=(id)=>{setJumpSourceId(id);setPage("sources");};

  const renderPage=()=>{
    switch(page){
      case "dashboard":return <Dashboard scope={scope} search={search} onNavigateSource={handleNavigateSource} onNavigatePage={handleNav}/>;
      case "opportunities":return <OpportunitiesSheet scope={scope} search={search}/>;
      case "sources":return <Sources scope={scope} search={search} initialSourceId={jumpSourceId}/>;
      case "digest":return <DailyDigest scope={scope}/>;
      case "weekly-digest":return <WeeklyDigest scope={scope}/>;
      case "alerts":return <Alerts/>;
      default:return <PlaceholderPage title={NAV.find(n=>n.id===page)?.label||"Page"} icon={NAV.find(n=>n.id===page)?.icon}/>;
    }
  };

  return(
    <ToastProvider>
      {showDisclaimer&&<Disclaimer onClose={()=>{setShowDisclaimer(false);sessionStorage.setItem("ioa-disclaimer-seen","1");}}/>}
      <div id="app" style={{display:"flex",height:"100vh",overflow:"hidden",width:"100%"}}>
        <Sidebar activePage={page} onNav={handleNav}/>
        <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",minWidth:0}}>
          <Header scope={scope} onScope={handleScope} search={search} onSearch={setSearch} activePage={page}/>
          <div style={{flex:1,overflow:"hidden"}}>
            {renderPage()}
          </div>
          <Footer/>
        </div>
      </div>
    </ToastProvider>
  );
}

ReactDOM.render(<App/>,document.getElementById("root"));
</script>
</body>
</html>
